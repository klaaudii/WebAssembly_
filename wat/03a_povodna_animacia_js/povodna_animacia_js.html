<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport">
    <title>Animation in JS</title>
</head>
<body>
<h3>Pôvodná implementácia v JS</h3>
<canvas id="canvas" width="512" height="512"></canvas><br>
<span id="frameRate"></span>
<script>

    const cnvs_size = 512;
    const object_count = 6000;
    const object_radius = 1.5;
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const object_size = object_radius*2
    const frameRate = document.getElementById("frameRate");

    function Ball(xx, yy, vx, vy) {
        this.xx = xx;
        this.yy = yy;
        this.vx = vx;
        this.vy = vy;

        this.move = () => {
            this.xx = (this.xx + this.vx) & 511;
            this.yy = (this.yy + this.vy) & 511;
        }

        this.draw = () => {
            ctx.fillRect(this.xx-object_radius,
                this.yy-object_radius,
                object_size, object_size)
        }

        this.checkCollision = (ball2) => {
            let dx = ball2.xx - this.xx;
            let dy = ball2.yy - this.yy;
            let d =  (dx**2 + dy**2)**0.5;
            if (d  < object_size){
                this.solveCollision();
                ball2.solveCollision();
            }
        }

        this.solveCollision = () => {
            this.vx *= -1;
            this.vy *= -1;
            this.xx += this.vx;
            this.yy += this.vy;
        }
    }

    let balls = new Array();
    let xx, yy, vxx, vyy;
    for (let i = 0; i < object_count; i++) {
        xx =  Math.floor(Math.random() * cnvs_size);
        yy = Math.floor(Math.random() * (cnvs_size-2*object_radius) + object_radius);
        tmp = (Math.round(Math.random() * 2) - 1);
        vxx = tmp === 0 ? 1 : tmp;
        tmp = (Math.round(Math.random() * 2) - 1);
        vyy = tmp === 0 ? 1 : tmp;
        balls.push(new Ball(xx,yy, vxx, vyy));
    }

    function clearCanvas() {
        ctx.fillStyle = "blue";
        ctx.fillRect(0, 0, cnvs_size, cnvs_size)
    }

    function moveObjects() {
        for (let i = 0; i < object_count; i++) {
            balls[i].move();
        }
    }

    function detectCollision() {
        for (i = 0; i < object_count; i++) {
            for (let j = 0; j < object_count; j++) {
                if (i === j) {
                    continue;
                }
                balls[i].checkCollision(balls[j]);
            }
        }
    }

    function drawObjects() {
        ctx.fillStyle = "red";
        for (i = 0; i < object_count; i++) {
            balls[i].draw();
        }
    }

    function animate() {
        moveObjects();
        detectCollision();
        clearCanvas();
        drawObjects();

        let t = performance.now();
        let dt = t - startTime;
        if (dt >= 1000) {
            let fps = frames * 1000 / dt;
            frameRate.innerHTML = "fps: "
                + fps.toString();
            frames = 0;
            startTime = t;
        }
        frames++;
        requestAnimationFrame(animate);
    }

    let startTime = performance.now();
    let frames = 0;
    requestAnimationFrame(animate);
</script>
</body>
</html>